# Medical Division PoC | Customer Base System (CBS)

### My Markdown Site
[TLabs-Streams](https://tstreams.netlify.com/)
---

### Overview
The system we will cover in this article is part of the Spring Framework :: A gentle introduction series. Specifically, in line with the PoC functionalities, we will develop the functionalities necessary to manage the customer base of our product.  

It manages the customer base: each user can be either a patient or a doctor or a service person in a doctor's office. Each user has an account to access the services provided by the system. Each account is provided with additional information that the system uses for the correct attribution of the services belonging to that particular user, both as a patient and medical staff.  

---
We are going to develop some business scenarios, even if simple, that will concern the following:  

- The registration of a generic user profile, intended by default as patient.
- Account activation for the first access to the system
- Access to the platform as a generic user that initiates the platform's verification of its profile as a doctor qualified to practice its profession.

The details of these three features will be discussed in detail in the next articles, also in terms of User Stories and Acceptance criteria

---

### Technical asset
It is a Spring Web Application deployed to Apache Tomcat as a WAR package.
The developed code is used to have a simple web application with the following topics, in according to actual articles provided by my personal web-site:
- Maven multi-modules Parent-Child Layout
- Spring 5 Web Application
- SOAP Web Services with Apache CXF
- Persistence with Hibernate/JPA
- Apache Tomcat
- PostgreSQL DB
- Docker/Docker-Compose project to manage Apache Tomcat Image and PostgreSQL DB

> Note: at this time in according to articles published, the application contains only SOAP Web Service definition and Docker/Docker-Compose for Tomcat

---
### Build and Run

#### First step

Clone the main project

```bash
git clone https://github.com/ant-giannone/tlabs-md-customer-base-sys
```

The **master branch** contains the merges of all other branches focused on a specific article published on my web-site
If you what view code for a specific articles, you only need to checkout on a specific branch


#### Second step

#### Third Step

Open your console and position yourself in the project folder **tlabs-md-customer-base-sys/docker**  

Here, you have the **docker** folder with docker compose and the necessary files for tomcat configuration.  
You have already a user settings for access to Tomcat Dashboard, the user is: 
- Username: tomcat-g
- Password: tomcat

Well, now you can type the command:  

```bash
docker-compose -f docker-compose.yml up -d
```

Next you can follow the logs if you type:
```bash
 docker logs -f tlabs-md-cbs
```

If you can see the following logging lines, your Tomcat is ready to used
```bash
08-Dec-2019 14:04:35.750 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler ["http-nio-8080"]
08-Dec-2019 14:04:35.858 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler ["ajp-nio-8009"]
08-Dec-2019 14:04:35.860 INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 12716 ms
```

If it is true that everything is ok, you should be able to access tomcat at the following url
```
http://localhost:8888/
```

Click on Manager App and insert Username/Password required: **tomcat-g/tomcat**


### Fourth Step

Open your console and position yourself in the project folder **tlabs-md-customer-base-sys**  

Type on console the following command and build all:

```bash
mvn clean package
```

Now you have the package **tlabs-md-cbs.war** placed in the path **tlabs-md-customer-base-sys/tlabs-md-customer-base-ptl/target**


### Fifth Step

Open In your browser the tomcat dashboard e manually deploy the package. If it's all ok, you can see a new app on tomcat application list: **/tlabs-md-cbs**  

Click on **/tlabs-md-cbs** and you can see the html default page generated by Apache CXF that list all SOAP Services available

### Final Step

We could play with SOAP service, well! You can use SOAP-UI and create a project from WSDL produce by Apache CXF or you can clone my project that use Cucumber and Gherkin for Integration Test example:


Clone the main project for integration test to verify SOAP endpoints and Scenarios written with Cucumber and Gherkin syntax

```bash
git clone https://github.com/ant-giannone/tlabs-md-customer-base-sys-integration-test
```

Position yourself on folder **tlabs-md-customer-base-sys-integration-test** and type the following command on your console:

```bash
mvn generate-sources
```
It creates soap client stub code from embedded WSDL in according with WebServices define by Web Application. 
Next Execute the integration test with the following command:

```bash
mvn test
```
When it's running you can see some logging info as follow:
```bash
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running org.tlabs.md.cbs.integration.CbsCucumberIntegrationTest
@cbs-integration
Feature: Activation Account
  As a software agent
  I want to be able to request activation account for a specific user
  So That the user can access the services of the system

  @cbs-integration
  Scenario: The user wants to activate his account   

 Given Software Agent must activate a user's account                                                                                                                                       # AccountActivationStep.prepareSoftwareAgent()
2019-12-08 15:23:48.417 [main] INFO  o.t.m.c.i.AccountActivationStep - SOAP Request Preparing
    And Software Agent prepares the request for activation account by filling it with the following data: temporary token, credential                                                         # AccountActivationStep.prepareRequest()
2019-12-08 15:23:48.422 [main] INFO  o.t.m.c.i.AccountActivationStep - SOAP Request Sending
    When Agent software sends the activation request to the system                                                                                                                            # AccountActivationStep.sendRequest()
2019-12-08 15:23:50.118 [main] INFO  o.t.m.c.i.AccountActivationStep - Handle Response
    Then The system check the temporary token that carrier expiration time and identity info and returns a response containing the following information: operation result code, message info # AccountActivationStep.handleResponse()                                                                                                                                         # features/ActivationCode.feature:8
```

And on Tomcat Logs some logging info as follow:
```bash
2019-12-08 14:23:50.603 [http-nio-8080-exec-5] INFO  o.a.c.s.C.RESP_OUT - RESP_OUT
    Content-Type: text/xml
    ResponseCode: 200
    ExchangeId: 5f576efa-170f-4c76-a68d-4b8a032f5812
    ServiceName: CustomerBaseRegistrationSN
    PortName: CustomerBaseRegistrationPN
    PortTypeName: CustomerBaseRegistrationN
    Headers: {}
    Payload: <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <ns1:newRegistrationResponse xmlns:ns1="http://service.ws.ptl.md.tlabs.org/">
      <newUserRegistrationResponse xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ns2="http://service.ws.ptl.md.tlabs.org/" xsi:type="ns2:newUserRegistrationResponse">
        <operationCode>NUR-S00</operationCode>
        <accountActivationLink>http://localhost:8888/tlabs-md-cbs/CustomerBaseManagerWs</accountActivationLink>
        <accountActivationCode>4786aa1d-2e0d-47bb-ba77-f446cc7f4c13</accountActivationCode>
      </newUserRegistrationResponse>
    </ns1:newRegistrationResponse>
  </soap:Body>
</soap:Envelope>
```
